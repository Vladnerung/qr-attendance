<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Авто-сканер QR — Отметка прихода</title>
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; text-align:center; padding:16px; }
  h1 { font-size: 24px; margin-bottom: 12px; }
  #reader { width: 100%; max-width: 400px; margin: 0 auto; }
  #status { margin-top: 12px; font-size: 18px; min-height: 28px; }
  #last { margin-top: 8px; font-size: 14px; color: #444; }
  .ok { color: green; }
  .err { color: #c33; }
  .info { color: #333; }
  button { margin-top: 10px; padding: 8px 16px; font-size: 16px; }
</style>
</head>
<body>

<h1>Авто-сканер QR — Отметка прихода</h1>
<div id="reader"></div>
<div id="status" class="info">Готов к сканированию. Поднесите QR к камере.</div>
<div id="last"></div>
<button id="restartBtn" style="display:none;">Возобновить сканирование</button>

<script>
  // ВАЖНО! Замени на свой ID формы Google
  const FORM_ID = "1J06h2mBt5Qp7OA1LTsiPVGM2l77u_XjmubBLg1Mg9Pc";

  // Поля формы (entry из твоей гугл-формы)
  const ENTRY_EMP = "entry.1614082679";    // QR данные сотрудника
  const ENTRY_SHIFT = "entry.656309949";  // Смена

  const FORM_URL = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`;

  const statusEl = document.getElementById('status');
  const lastEl = document.getElementById('last');
  const restartBtn = document.getElementById('restartBtn');

  function getShiftByTime(date = new Date()) {
    const h = date.getHours();
    if (h >= 7 && h < 17) return "1-я смена";
    if (h >= 18 || h < 5) return "2-я смена";
    return "Вне смены";
  }

  let lastSent = { text: null, ts: 0 };
  const DEBOUNCE_MS = 2000;

  async function sendToGoogleForm(qrText) {
    const now = new Date();
    const shift = getShiftByTime(now);

    if (shift === "Вне смены") {
      statusEl.textContent = "⛔ Сейчас вне времени смен — отметка не принимается.";
      statusEl.className = "err";
      return;
    }

    const t = Date.now();
    if (lastSent.text === qrText && t - lastSent.ts < DEBOUNCE_MS) {
      statusEl.textContent = "⏳ Пожалуйста, подержите код подальше на секунду...";
      statusEl.className = "info";
      return;
    }
    lastSent = { text: qrText, ts: t };

    const formData = new URLSearchParams();
    formData.append(ENTRY_EMP, qrText);
    formData.append(ENTRY_SHIFT, shift);

    try {
      await fetch(FORM_URL, { method: "POST", mode: "no-cors", body: formData });
      statusEl.textContent = `✅ Отметка принята — ${shift}`;
      statusEl.className = "ok";
      lastEl.textContent = `Содержимое QR: ${qrText} — ${now.toLocaleString()}`;
    } catch (e) {
      statusEl.textContent = "⚠️ Ошибка отправки (проверьте интернет/FORM_ID/entry)";
      statusEl.className = "err";
      lastEl.textContent = `QR: ${qrText}`;
    }

    setTimeout(() => {
      statusEl.textContent = "Готов к сканированию. Поднесите QR к камере.";
      statusEl.className = "info";
    }, 2500);
  }

  function onScanSuccess(decodedText, decodedResult) {
    html5QrCode.stop().then(() => {
      sendToGoogleForm(decodedText);
      restartBtn.style.display = "inline-block";
    });
  }

  const html5QrCode = new Html5Qrcode("reader");
  const config = { fps: 10, qrbox: { width: 300, height: 200 } };

  function startScanner() {
    statusEl.textContent = "Инициализация камеры...";
    Html5Qrcode.getCameras()
      .then(cameras => {
        if (cameras && cameras.length) {
          // Ищем заднюю камеру (названия часто содержат "back" или "rear")
          const backCamera = cameras.find(cam =>
            cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("rear"));
          const cameraId = backCamera ? backCamera.id : cameras[0].id;

          html5QrCode.start(cameraId, config, onScanSuccess, errorMessage => {
            // Можно логировать ошибки, но не выводить в UI
            // console.log("Scan error:", errorMessage);
          })
          .then(() => {
            statusEl.textContent = "Готов к сканированию. Поднесите QR к камере.";
            statusEl.className = "info";
            restartBtn.style.display = "none";
          })
          .catch(err => {
            statusEl.textContent = "Ошибка запуска камеры: " + err;
            statusEl.className = "err";
            console.error("Camera start error:", err);
          });
        } else {
          statusEl.textContent = "Камера не найдена";
          statusEl.className = "err";
        }
      })
      .catch(err => {
        statusEl.textContent = "Ошибка доступа к камере: " + err;
        statusEl.className = "err";
      });
  }

  restartBtn.addEventListener("click", () => {
    startScanner();
  });

  window.addEventListener("load", startScanner);
</script>

</body>
</html>
